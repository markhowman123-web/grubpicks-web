<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grub Picks Stake Form</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--tg-theme-bg-color, #121212);
      color: var(--tg-theme-text-color, #f5f5f5);
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: var(--tg-theme-text-color, inherit);
    }

    .card {
      background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.06));
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
      max-width: 480px;
      margin: 0 auto;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 1rem;
      border-radius: 8px;
      border: 1px solid var(--tg-theme-hint-color, #444);
      background: var(--tg-theme-bg-color, #181818);
      color: inherit;
      font-size: 1rem;
      box-sizing: border-box;
    }

    input:focus {
      outline: 2px solid var(--tg-theme-button-color, #2481cc);
      outline-offset: 2px;
    }

    .bet-id {
      font-weight: 600;
      margin-bottom: 1rem;
      padding: 8px 12px;
      background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.06));
      border-radius: 8px;
      word-break: break-word;
    }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--tg-theme-button-text-color, #fff);
      background: var(--tg-theme-button-color, #2481cc);
      transition: opacity 0.2s ease;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error {
      color: var(--tg-theme-destructive-text-color, #ff5c5c);
      margin: -0.5rem 0 1rem;
      font-size: 0.85rem;
    }

    .status {
      margin: -0.5rem 0 1rem;
      font-size: 0.85rem;
      color: var(--tg-theme-hint-color, #bbb);
    }

    .status[data-state='success'] {
      color: var(--tg-theme-button-color, #2481cc);
    }

    .status[data-state='error'] {
      color: var(--tg-theme-destructive-text-color, #ff5c5c);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Submit Stake</h1>
    <div id="bet-id" class="bet-id"></div>
    <form id="stake-form">
      <label for="stake">Stake</label>
      <input
        id="stake"
        name="stake"
        type="text"
        inputmode="decimal"
        placeholder="e.g. 25.50"
        autocomplete="off"
        required
      />

      <label for="price">Odds (Price)</label>
      <input
        id="price"
        name="price"
        type="text"
        inputmode="decimal"
        placeholder="e.g. 3.75"
        autocomplete="off"
        required
      />

      <p id="error" class="error" hidden></p>
      <p id="status" class="status" hidden></p>

      <button id="submit" class="button" type="submit">Submit stake</button>
    </form>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const betId = params.get('betId')?.trim() || '';
      const rawSubmitUrl = params.get('submitUrl');
      const submitUrl = normaliseHttpsUrl(rawSubmitUrl);
      const authToken = params.get('authToken')?.trim() || '';
      const betIdEl = document.getElementById('bet-id');
      const form = document.getElementById('stake-form');
      const stakeInput = document.getElementById('stake');
      const priceInput = document.getElementById('price');
      const errorEl = document.getElementById('error');
      const statusEl = document.getElementById('status');
      const submitButton = document.getElementById('submit');

      const webApp = window.Telegram?.WebApp;
      if (webApp) {
        webApp.ready();
      }

      if (rawSubmitUrl && !submitUrl) {
        console.warn('Stake submit URL parameter is invalid. Falling back to Telegram submission.');
      }

      function updateBetIdDisplay() {
        if (betId) {
          betIdEl.textContent = `Bet ID: ${betId}`;
        } else {
          betIdEl.textContent = 'Bet ID is missing. Provide a betId query parameter.';
          submitButton.disabled = true;
        }
      }

      function setStatus(message = '', state) {
        if (!statusEl) {
          return;
        }

        if (!message) {
          statusEl.hidden = true;
          statusEl.textContent = '';
          delete statusEl.dataset.state;
          return;
        }

        statusEl.textContent = message;
        statusEl.hidden = false;

        if (state) {
          statusEl.dataset.state = state;
        } else {
          delete statusEl.dataset.state;
        }
      }

      function normaliseHttpsUrl(value) {
        if (value === null || value === undefined) {
          return '';
        }

        const trimmed = value.toString().trim();
        if (!trimmed) {
          return '';
        }

        try {
          const url = new URL(trimmed);
          if (url.protocol !== 'https:') {
            return '';
          }
          return url.toString();
        } catch (error) {
          return '';
        }
      }

      function normaliseNumber(value) {
        if (typeof value !== 'string') {
          return NaN;
        }

        const trimmed = value.trim();
        if (!trimmed) {
          return NaN;
        }

        const isNegative = trimmed.startsWith('-');
        let unsigned = isNegative ? trimmed.slice(1) : trimmed;

        unsigned = unsigned.replace(/['\s\u00a0]/g, '');
        const cleaned = unsigned.replace(/[^0-9.,]/g, '');
        if (!cleaned) {
          return NaN;
        }

        const lastComma = cleaned.lastIndexOf(',');
        const lastDot = cleaned.lastIndexOf('.');
        let decimalIndex = -1;

        if (lastComma !== -1 && lastDot !== -1) {
          decimalIndex = Math.max(lastComma, lastDot);
        } else if (lastComma !== -1) {
          const commaCount = cleaned.split(',').length - 1;
          const looksLikeThousands = /^\d{1,3}(,\d{3})+$/.test(cleaned) && !cleaned.startsWith('0');
          if (!looksLikeThousands) {
            const fractionLength = cleaned.length - lastComma - 1;
            if (fractionLength > 0) {
              decimalIndex = lastComma;
            }
          } else if (commaCount > 1) {
            const fractionLength = cleaned.length - lastComma - 1;
            if (fractionLength > 0 && fractionLength <= 2) {
              decimalIndex = lastComma;
            }
          }
        } else if (lastDot !== -1) {
          const dotCount = cleaned.split('.').length - 1;
          const looksLikeThousands = /^\d{1,3}(\.\d{3})+$/.test(cleaned) && !cleaned.startsWith('0');
          if (!looksLikeThousands || dotCount === 1) {
            const fractionLength = cleaned.length - lastDot - 1;
            if (fractionLength > 0) {
              decimalIndex = lastDot;
            }
          }
        }

        let integerPart = cleaned;
        let fractionalPart = '';

        if (decimalIndex !== -1) {
          integerPart = cleaned.slice(0, decimalIndex);
          fractionalPart = cleaned.slice(decimalIndex + 1);
        }

        const integerDigits = integerPart.replace(/[.,]/g, '');
        const fractionalDigits = fractionalPart.replace(/[.,]/g, '');

        let numberString = integerDigits;

        if (!numberString && fractionalDigits) {
          numberString = '0';
        }

        if (!numberString) {
          return NaN;
        }

        if (fractionalDigits) {
          numberString += `.${fractionalDigits}`;
        }

        if (isNegative) {
          numberString = `-${numberString}`;
        }

        const result = Number.parseFloat(numberString);
        return Number.isFinite(result) ? result : NaN;
      }

      function validate() {
        const stakeValue = normaliseNumber(stakeInput.value);
        const priceValue = normaliseNumber(priceInput.value);
        setStatus('');

        if (!betId) {
          errorEl.textContent = 'Bet ID is required.';
          errorEl.hidden = false;
          return false;
        }

        if (!Number.isFinite(stakeValue) || stakeValue <= 0) {
          errorEl.textContent = 'Enter a valid stake greater than 0.';
          errorEl.hidden = false;
          return false;
        }

        if (!Number.isFinite(priceValue) || priceValue <= 1) {
          errorEl.textContent = 'Enter valid odds greater than 1.0.';
          errorEl.hidden = false;
          return false;
        }

        errorEl.hidden = true;
        return { stakeValue, priceValue };
      }

      form.addEventListener('submit', async function (event) {
        event.preventDefault();

        const result = validate();
        if (!result) {
          return;
        }

        const { stakeValue, priceValue } = result;
        const payload = {
          betId,
          stake: Number(stakeValue.toFixed(2)),
          price: Number(priceValue.toFixed(3)),
        };

        submitButton.disabled = true;
        errorEl.hidden = true;

        if (submitUrl) {
          setStatus('Sending stake…');

          try {
            const headers = {
              'Content-Type': 'application/json',
              Accept: 'application/json',
            };
            if (authToken) {
              headers.Authorization = /\s/.test(authToken)
                ? authToken
                : `Bearer ${authToken}`;
            }

            const response = await fetch(submitUrl, {
              method: 'POST',
              headers,
              body: JSON.stringify(payload),
            });

            if (!response.ok) {
              const errorText = await response.text().catch(() => '');
              throw new Error(errorText || `Request failed with status ${response.status}`);
            }

            webApp?.showToast?.({ text: 'Stake submitted' });
            setStatus('Stake submitted successfully.', 'success');
            submitButton.disabled = false;
            webApp?.close?.();
            return;
          } catch (error) {
            console.error('Failed to submit stake to endpoint', error);
            setStatus('Failed to submit stake. Please try again.', 'error');
            webApp?.showAlert?.('Failed to submit stake. Please try again.');
            submitButton.disabled = false;
            return;
          }
        }

        if (!webApp || typeof webApp.sendData !== 'function') {
          console.warn('No submission path available for stake payload', payload);
          setStatus('No submission endpoint is configured. Stake not sent.', 'error');
          submitButton.disabled = false;
          return;
        }

        setStatus('Sending stake via Telegram…');

        try {
          webApp.sendData(JSON.stringify(payload));
          webApp.showToast?.({ text: 'Stake sent' });
          setStatus('Stake sent via Telegram.', 'success');
          submitButton.disabled = false;
          webApp.close?.();
        } catch (error) {
          console.error('Unable to send data to Telegram', error);
          setStatus('Failed to send stake. Please try again.', 'error');
          webApp?.showAlert?.('Failed to send stake. Please try again.');
          submitButton.disabled = false;
        }
      });

      updateBetIdDisplay();
    })();
  </script>
</body>
</html>
