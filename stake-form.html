<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grub Picks Stake Form</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      color-scheme: light dark;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      padding: 16px;
      background: var(--tg-theme-bg-color, #121212);
      color: var(--tg-theme-text-color, #f5f5f5);
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
      color: var(--tg-theme-text-color, inherit);
    }

    .card {
      background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.06));
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12);
      max-width: 480px;
      margin: 0 auto;
    }

    label {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }

    input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 1rem;
      border-radius: 8px;
      border: 1px solid var(--tg-theme-hint-color, #444);
      background: var(--tg-theme-bg-color, #181818);
      color: inherit;
      font-size: 1rem;
      box-sizing: border-box;
    }

    input:focus {
      outline: 2px solid var(--tg-theme-button-color, #2481cc);
      outline-offset: 2px;
    }

    .bet-id {
      font-weight: 600;
      margin-bottom: 1rem;
      padding: 8px 12px;
      background: var(--tg-theme-secondary-bg-color, rgba(255, 255, 255, 0.06));
      border-radius: 8px;
      word-break: break-word;
    }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 999px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--tg-theme-button-text-color, #fff);
      background: var(--tg-theme-button-color, #2481cc);
      transition: opacity 0.2s ease;
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .error {
      color: var(--tg-theme-destructive-text-color, #ff5c5c);
      margin: -0.5rem 0 1rem;
      font-size: 0.85rem;
    }

    .status {
      margin-top: 0.75rem;
      font-size: 0.9rem;
      color: var(--tg-theme-button-color, #2481cc);
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Submit Stake</h1>
    <div id="bet-id" class="bet-id"></div>
    <form id="stake-form">
      <label for="stake">Stake</label>
      <input
        id="stake"
        name="stake"
        type="text"
        inputmode="decimal"
        placeholder="e.g. 25.50"
        autocomplete="off"
        required
      />

      <label for="price">Odds (Price)</label>
      <input
        id="price"
        name="price"
        type="text"
        inputmode="decimal"
        placeholder="e.g. 3.75"
        autocomplete="off"
        required
      />

      <p id="error" class="error" hidden></p>

      <button id="submit" class="button" type="submit">Send to GrubPicks bot</button>
      <p id="status" class="status" hidden></p>
    </form>
  </div>

  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const betId = params.get('betId')?.trim() || '';
      const betIdEl = document.getElementById('bet-id');
      const form = document.getElementById('stake-form');
      const stakeInput = document.getElementById('stake');
      const priceInput = document.getElementById('price');
      const errorEl = document.getElementById('error');
      const submitButton = document.getElementById('submit');
      const statusEl = document.getElementById('status');

      const webApp = window.Telegram?.WebApp;
      if (webApp) {
        webApp.ready();
      }

      function updateBetIdDisplay() {
        if (betId) {
          betIdEl.textContent = `Bet ID: ${betId}`;
        } else {
          betIdEl.textContent = 'Bet ID is missing. Provide a betId query parameter.';
          submitButton.disabled = true;
        }
      }

      function normaliseNumber(value) {
        const normalised = value.replace(/[^0-9.,-]/g, '').replace(',', '.');
        if (!normalised) {
          return NaN;
        }
        return parseFloat(normalised);
      }

      function validate() {
        const stakeValue = normaliseNumber(stakeInput.value);
        const priceValue = normaliseNumber(priceInput.value);

        if (!betId) {
          errorEl.textContent = 'Bet ID is required.';
          errorEl.hidden = false;
          return false;
        }

        if (!Number.isFinite(stakeValue) || stakeValue <= 0) {
          errorEl.textContent = 'Enter a valid stake greater than 0.';
          errorEl.hidden = false;
          return false;
        }

        if (!Number.isFinite(priceValue) || priceValue <= 1) {
          errorEl.textContent = 'Enter valid odds greater than 1.0.';
          errorEl.hidden = false;
          return false;
        }

        errorEl.hidden = true;
        return { stakeValue, priceValue };
      }

      function setFormDisabled(isDisabled) {
        [stakeInput, priceInput, submitButton].forEach((element) => {
          element.disabled = isDisabled;
        });
      }

      form.addEventListener('submit', async function (event) {
        event.preventDefault();

        statusEl.hidden = true;

        const result = validate();
        if (!result) {
          return;
        }

        const { stakeValue, priceValue } = result;
        const payload = {
          betId,
          stake: Number(stakeValue.toFixed(2)),
          price: Number(priceValue.toFixed(3)),
        };

        let closeTimeoutId = null;
        try {
          const sendResult = webApp?.sendData?.(JSON.stringify(payload));
          await Promise.resolve(sendResult);

          statusEl.textContent = 'Stake sent to GrubPicks bot.';
          statusEl.hidden = false;

          setFormDisabled(true);
          webApp?.showToast?.({ text: 'Stake sent' });

          closeTimeoutId = window.setTimeout(() => {
            webApp?.close?.();
          }, 1200);
        } catch (error) {
          console.error('Unable to send data to Telegram', error);
          if (closeTimeoutId !== null) {
            clearTimeout(closeTimeoutId);
            closeTimeoutId = null;
          }
          setFormDisabled(false);
          statusEl.hidden = true;
        } finally {
          if (closeTimeoutId === null) {
            setFormDisabled(false);
          }
        }
      });

      updateBetIdDisplay();
    })();
  </script>
</body>
</html>
